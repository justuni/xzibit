
     THE XZIBIT PROTOCOL

= BACKGROUND =

The Xzibit protocol is unidirectional; the receiver sends no acknowledgement
or response.  It is expected that the protocol's streams will be paired,
one in each direction, as in TCP.

Every window shared across a connection has an "Xzibit ID", a unique number
which fits in a non-zero unsigned sixteen-bit word.  This may be the same
as the X ID of the realised window on one end, but need not be.

Where an endpoint may communicate with multiple other endpoints, it
may need to identify a window with a combination of its Xzibit ID
and an identifier for the remote endpoint.

The Xzibit protocol listens on port 1770 plus the number of the X display
it is using.  If it is accepting connections over Tubes, it should
probably deny connections from anywhere but localhost.

= THE PROTOCOL =

Communications over the Xzibit protocol begin with a header as follows:

   Xz 001.000\r\n

or in ASCII hex

   58 7a 20 30 30 31 2e 30 30 30 0d 0a

The Xzibit protocol multiplexes one or more channels.  Each channel is
identified by an unsigned sixteen-bit word.  The channels are of
two kinds:

  * a single control channel, identified as zero, which is always open.
  This uses a custom protocol described below.

  * zero or more RFB channels, identified by the Xzibit IDs of the
  windows they represent.  These use the RFB protocol, as used by VNC.

The protocol is divided into blocks.  After the header is sent, the
channel is ready to send its first block.  A block consists of a
four-byte header:

    <channel> <length>

where <channel> is a sixteen-bit little-endian word giving the channel
ID, which must be either zero or the Xzibit ID of an open window,
and <length> is a sixteen-bit little-endian word giving a length in
bytes.  This is followed by <length> bytes, which are sent to channel
<channel>.  After this, we are again outside any block.

= THE CONTROL CHANNEL =

A message on the control channel begins with a single-byte opcode, optionally
continues with a series of bytes which are interpreted according to that
opcode, and ends with a break signal, as described in the previous section.
In an environment where there are no out-of-band break signals, messages
should begin with a word giving their length.  This never happens in practice.

All unrecognised or malformed messages on the control channel should be ignored.

The defined opcodes are:

 0x01 OPEN, followed by two bytes giving the ID of the channel to open.
            This channel may henceforth be switched to.
 0x02 CLOSE, followed by two bytes giving the ID of the channel to close.
            This channel may no longer be switched to.
 0x03 SET, followed by two bytes defining which metadata to set; followed
            by two bytes giving Xzibit ID of the window to set, which may
            not be zero; possibly followed by data giving the new value of
            that metadata.  See the metadata section, below.
 0x04 WALL, followed by two bytes, which form a sixteen-bit error code,
            being 0 for success and nonzero for an error; followed by
            UTF-8-encoded text which should be displayed to
            the remote user.  The values of the error code are ill-defined
            at present.

= METADATA =

The defined metadata types, and the interpretation of the value data, are
as follows.  "w" is the Xzibit ID of the window whose metadata is changing.

 0x0001 TRANSIENCY.  Followed by three two-byte words, "p", "x", "y".
   If p==0 or p==w, w becomes intransient.
   Otherwise, w becomes transient to p; in this case, "w" is moved to
   the coordinates of "p" translated southeast by "x","y".

 0x0002 NAME.  Followed by the new title of the window, UTF-8 encoded.

 0x0003 TYPE.  Followed by one byte, the new type of the window:

 * B = _NET_WM_WINDOW_TYPE_TOOLBAR
 * C = _NET_WM_WINDOW_TYPE_COMBO
 * D = _NET_WM_WINDOW_TYPE_DIALOG
 * M = _NET_WM_WINDOW_TYPE_MENU
 * N = _NET_WM_WINDOW_TYPE_NOTIFICATION
 * P = _NET_WM_WINDOW_TYPE_POPUP_MENU
 * R = _NET_WM_WINDOW_TYPE_DROPDOWN_MENU
 * S = _NET_WM_WINDOW_TYPE_SPLASH
 * T = _NET_WM_WINDOW_TYPE_TOOLTIP
 * U = _NET_WM_WINDOW_TYPE_UTILITY
 * X = _NET_WM_WINDOW_TYPE_NORMAL
 * _NET_WM_WINDOW_TYPE_DESKTOP does not get shared, so has no code
 * _NET_WM_WINDOW_TYPE_DOCK does not get shared, so has no code
 * _NET_WM_WINDOW_TYPE_DND is not shared because of being far too complicated for a first draft 

 0x0004 ICON.  Followed by the icon for the window, in PNG format.
